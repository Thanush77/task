class TaskManager{constructor(){this.tasks=[];this.users=[];this.currentFilters={};this.currentEditingTask=null;this.refreshInterval=null;this.notificationIntervals={};this.init=this.init.bind(this);this.loadTasks=this.loadTasks.bind(this);this.loadUsers=this.loadUsers.bind(this);this.loadDashboardStats=this.loadDashboardStats.bind(this);this.scheduleDeadlineNotifications=this.scheduleDeadlineNotifications.bind(this);this.clearAllNotificationIntervals=this.clearAllNotificationIntervals.bind(this)}async init(){try{console.log("ğŸš€ Initializing TaskManager...");await Promise.all([this.loadUsers(),this.loadTasks(),this.loadDashboardStats()]);this.setupEventListeners();this.setupAutoRefresh();console.log("âœ… TaskManager initialized successfully")}catch(error){console.error("âŒ Failed to initialize TaskManager:",error);showNotification("Failed to load application data. Please refresh the page.","error")}}setupEventListeners(){const taskForm=document.getElementById("taskForm");if(taskForm){taskForm.addEventListener("submit",e=>{e.preventDefault();this.handleTaskSubmit()})}const searchInput=document.getElementById("searchTasks");if(searchInput){let searchTimeout;searchInput.addEventListener("input",()=>{clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>this.filterTasks(),300)})}document.addEventListener("click",e=>{if(e.target.classList.contains("modal")){this.closeAllModals()}});document.addEventListener("keydown",e=>{this.handleKeyboardShortcuts(e)})}setupAutoRefresh(){this.refreshInterval=setInterval(async()=>{if(document.visibilityState==="visible"){await this.loadDashboardStats();const activeTab=document.querySelector(".tab-content.active");if(activeTab&&activeTab.id==="tasks"){await this.loadTasks()}}},3e4)}async loadUsers(){try{const response=await window.api.getUsers();this.users=response.users||response;this.populateUserSelects();this.renderTeamGrid();console.log(`ğŸ‘¥ Loaded ${this.users.length} users`)}catch(error){console.error("âŒ Failed to load users:",error);showNotification("Failed to load team members.","error")}}async loadTasks(){try{const response=await window.api.getTasks(this.currentFilters);this.tasks=response.tasks||response;this.renderTasks();this.scheduleDeadlineNotifications();console.log(`ğŸ“‹ Loaded ${this.tasks.length} tasks`)}catch(error){console.error("âŒ Failed to load tasks:",error);this.renderTasksError();showNotification("Failed to load tasks.","error")}}async loadDashboardStats(){try{const stats=await window.api.getDashboardStats();this.updateDashboard(stats)}catch(error){console.error("âŒ Failed to load dashboard stats:",error)}}populateUserSelects(){const selects=document.querySelectorAll("#taskAssignTo");selects.forEach(select=>{select.innerHTML='<option value="">Select team member</option>';this.users.forEach(user=>{const option=document.createElement("option");option.value=user.id;const isCurrentUser=window.authManager.getCurrentUser()?.id===user.id;option.textContent=`${user.full_name} ${isCurrentUser?"(Me)":""}`;select.appendChild(option)})})}async handleTaskSubmit(){try{const taskData=this.getTaskFormData();if(!taskData.title.trim()){showNotification("Task title is required.","error");return}if(!taskData.assignedTo){showNotification("Please select a team member to assign the task.","error");return}this.setTaskFormLoading(true);let response;let isNewTask=false;let assignedUserId=taskData.assignedTo;let assignedUserName="";if(this.currentEditingTask){response=await window.api.updateTask(this.currentEditingTask.id,taskData);showNotification("Task updated successfully!","success");if(this.currentEditingTask.assigned_to!==assignedUserId){assignedUserName=this.users.find(u=>u.id===assignedUserId)?.full_name||"";this.notifyTaskAssignment(taskData.title,assignedUserId,assignedUserName)}}else{response=await window.api.createTask(taskData);showNotification("Task created successfully!","success");isNewTask=true;assignedUserName=this.users.find(u=>u.id===assignedUserId)?.full_name||"";this.notifyTaskAssignment(taskData.title,assignedUserId,assignedUserName)}await Promise.all([this.loadTasks(),this.loadDashboardStats()]);this.closeTaskModal()}catch(error){console.error("âŒ Task submit error:",error);showNotification(error.getUserMessage(),"error")}finally{this.setTaskFormLoading(false)}}getTaskFormData(){return{title:document.getElementById("taskTitle").value.trim(),description:document.getElementById("taskDescription").value.trim()||null,assignedTo:parseInt(document.getElementById("taskAssignTo").value)||null,priority:document.getElementById("taskPriority").value,category:document.getElementById("taskCategory").value,estimatedHours:parseFloat(document.getElementById("taskEstimatedHours").value)||1,startDate:document.getElementById("taskStartDate").value||null,dueDate:document.getElementById("taskDueDate").value||null,tags:document.getElementById("taskTags").value.split(",").map(tag=>tag.trim()).filter(tag=>tag)}}setTaskFormLoading(isLoading){const submitBtn=document.getElementById("taskSubmitBtn");if(!submitBtn)return;const textSpan=submitBtn.querySelector(".btn-text");const loaderSpan=submitBtn.querySelector(".btn-loader");if(isLoading){submitBtn.disabled=true;if(textSpan)textSpan.style.display="none";if(loaderSpan){loaderSpan.style.display="flex"}}else{submitBtn.disabled=false;if(textSpan)textSpan.style.display="block";if(loaderSpan)loaderSpan.style.display="none"}}async completeTask(taskId){try{await window.api.updateTask(taskId,{status:"completed"});const task=this.tasks.find(t=>t.id===taskId);if(task){task.status="completed";task.completed_at=(new Date).toISOString()}this.clearNotificationInterval(taskId);await Promise.all([this.loadTasks(),this.loadDashboardStats()]);showNotification("Task completed! ğŸ‰","success")}catch(error){console.error("âŒ Complete task error:",error);showNotification(error.getUserMessage(),"error")}}async deleteTask(taskId){if(!confirm("Are you sure you want to delete this task? This action cannot be undone.")){return}try{await window.api.deleteTask(taskId);this.tasks=this.tasks.filter(t=>t.id!==taskId);this.clearNotificationInterval(taskId);await Promise.all([this.loadTasks(),this.loadDashboardStats()]);showNotification("Task deleted successfully.","info")}catch(error){console.error("âŒ Delete task error:",error);showNotification(error.getUserMessage(),"error")}}editTask(taskId){const task=this.tasks.find(t=>t.id===taskId);if(!task){showNotification("Task not found.","error");return}this.currentEditingTask=task;this.populateTaskForm(task);this.openTaskModal("Edit Task")}populateTaskForm(task){document.getElementById("taskTitle").value=task.title||"";document.getElementById("taskDescription").value=task.description||"";document.getElementById("taskAssignTo").value=task.assigned_to||"";document.getElementById("taskPriority").value=task.priority||"medium";document.getElementById("taskCategory").value=task.category||"general";document.getElementById("taskEstimatedHours").value=task.estimated_hours||1;if(task.start_date){document.getElementById("taskStartDate").value=this.formatDateTimeLocal(task.start_date)}if(task.due_date){document.getElementById("taskDueDate").value=this.formatDateTimeLocal(task.due_date)}const tags=task.tags?task.tags.filter(tag=>tag).join(", "):"";document.getElementById("taskTags").value=tags}formatDateTimeLocal(dateString){const date=new Date(dateString);const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,"0");const day=String(date.getDate()).padStart(2,"0");const hours=String(date.getHours()).padStart(2,"0");const minutes=String(date.getMinutes()).padStart(2,"0");return`${year}-${month}-${day}T${hours}:${minutes}`}async filterTasks(){const statusFilter=document.getElementById("statusFilter").value;const priorityFilter=document.getElementById("priorityFilter").value;const searchQuery=document.getElementById("searchTasks").value.trim();this.currentFilters={};if(statusFilter)this.currentFilters.status=statusFilter;if(priorityFilter)this.currentFilters.priority=priorityFilter;await this.loadTasks();if(searchQuery){this.tasks=this.tasks.filter(task=>task.title.toLowerCase().includes(searchQuery.toLowerCase())||task.description&&task.description.toLowerCase().includes(searchQuery.toLowerCase())||task.assigned_to_name&&task.assigned_to_name.toLowerCase().includes(searchQuery.toLowerCase()))}this.renderTasks()}searchTasks(){this.filterTasks()}renderTasks(){const tasksList=document.getElementById("tasksList");if(!tasksList)return;if(this.tasks.length===0){tasksList.innerHTML=this.getEmptyTasksHTML();return}const tasksHTML=this.tasks.map(task=>this.renderTask(task)).join("");tasksList.innerHTML=tasksHTML;this.tasks.forEach(task=>{this.updateTimerDisplay(task.id)})}renderTask(task){const priorityClass=`priority-${task.priority}`;const dueDate=task.due_date?new Date(task.due_date).toLocaleDateString():"No due date";const assignedToName=task.assigned_to_name||"Unassigned";const tags=task.tags?task.tags.filter(tag=>tag).map(tag=>`<span class="task-tag">${this.escapeHtml(tag)}</span>`).join(""):"";const isCompleted=task.status==="completed";const canEdit=task.created_by===window.authManager.getCurrentUser()?.id||task.assigned_to===window.authManager.getCurrentUser()?.id;const timeControls=`\n            <div class="task-timer" id="task-timer-${task.id}">\n                <span class="timer-display" id="timer-display-${task.id}">--:--:--</span>\n                <span class="timer-total" id="timer-total-${task.id}" style="margin-left:8px;font-size:0.9em;color:#888;">Total: --:--:--</span>\n                <button class="btn btn-small btn-primary" onclick="taskManager.startTimer(${task.id})">â–¶ï¸ Start</button>\n                <button class="btn btn-small btn-warning" onclick="taskManager.pauseTimer(${task.id})">â¸ï¸ Pause</button>\n                <button class="btn btn-small btn-danger" onclick="taskManager.stopTimer(${task.id})">â¹ï¸ Stop</button>\n            </div>\n        `;return`\n            <div class="task-item ${priorityClass}" data-task-id="${task.id}">\n                <div class="task-header">\n                    <div class="task-title">${this.escapeHtml(task.title)}</div>\n                    <div class="task-priority ${priorityClass}">${task.priority}</div>\n                </div>\n                \n                ${task.description?`<div class="task-description">${this.escapeHtml(task.description)}</div>`:""}\n                \n                <div class="task-meta">\n                    <span>ğŸ‘¤ ${this.escapeHtml(assignedToName)}</span>\n                    <span>ğŸ“… ${dueDate}</span>\n                    <span>â±ï¸ ${task.estimated_hours}h</span>\n                    <span>ğŸ“‚ ${this.escapeHtml(task.category)}</span>\n                    ${task.created_by_name?`<span>ğŸ‘¨â€ğŸ’¼ Created by ${this.escapeHtml(task.created_by_name)}</span>`:""}\n                </div>\n                \n                ${tags?`<div class="task-tags">${tags}</div>`:""}\n                \n                <div class="task-actions">\n                    ${!isCompleted?`<button class="btn btn-success btn-small" onclick="taskManager.completeTask(${task.id})">\n                            âœ… Complete\n                        </button>`:`<span style="color: var(--success-color); font-weight: 600;">âœ… Completed</span>`}\n                    ${canEdit?`<button class="btn btn-secondary btn-small" onclick="taskManager.editTask(${task.id})">\n                            âœï¸ Edit\n                        </button>`:""}\n                    ${task.created_by===window.authManager.getCurrentUser()?.id?`<button class="btn btn-danger btn-small" onclick="taskManager.deleteTask(${task.id})">\n                            ğŸ—‘ï¸ Delete\n                        </button>`:""}\n                </div>\n                ${!isCompleted?timeControls:""}\n            </div>\n        `}renderTasksError(){const tasksList=document.getElementById("tasksList");if(!tasksList)return;tasksList.innerHTML=`\n            <div class="empty-state">\n                <div style="font-size: 4rem; margin-bottom: 16px;">âŒ</div>\n                <h3>Failed to Load Tasks</h3>\n                <p>There was an error loading your tasks. Please try refreshing the page.</p>\n                <button class="btn btn-primary" onclick="taskManager.loadTasks()" style="margin-top: 1rem;">\n                    ğŸ”„ Retry\n                </button>\n            </div>\n        `}getEmptyTasksHTML(){const hasFilters=Object.keys(this.currentFilters).length>0||document.getElementById("searchTasks").value.trim();if(hasFilters){return`\n                <div class="empty-state">\n                    <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ”</div>\n                    <h3>No Tasks Found</h3>\n                    <p>No tasks match your current filters. Try adjusting your search criteria.</p>\n                    <button class="btn btn-secondary" onclick="taskManager.clearFilters()" style="margin-top: 1rem;">\n                        Clear Filters\n                    </button>\n                </div>\n            `}return`\n            <div class="empty-state">\n                <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ“</div>\n                <h3>No Tasks Yet</h3>\n                <p>Create your first task to get started with task management!</p>\n                <button class="btn btn-primary" onclick="openCreateTaskModal()" style="margin-top: 1rem;">\n                    â• Create First Task\n                </button>\n            </div>\n        `}clearFilters(){document.getElementById("statusFilter").value="";document.getElementById("priorityFilter").value="";document.getElementById("searchTasks").value="";this.currentFilters={};this.loadTasks()}updateDashboard(stats){const elements={totalTasks:document.getElementById("totalTasks"),completedTasks:document.getElementById("completedTasks"),inProgressTasks:document.getElementById("inProgressTasks"),assignedToMe:document.getElementById("assignedToMe"),assignedByMe:document.getElementById("assignedByMe"),timeToday:document.getElementById("timeToday")};Object.keys(elements).forEach(key=>{if(elements[key]&&stats[key]!==undefined){elements[key].textContent=stats[key]}});Object.values(elements).forEach(el=>{if(el){el.classList.add("animate-pulse");setTimeout(()=>el.classList.remove("animate-pulse"),1e3)}})}renderTeamGrid(){const teamGrid=document.getElementById("teamGrid");const teamCount=document.getElementById("teamCount");if(!teamGrid)return;if(teamCount){teamCount.textContent=this.users.length}if(this.users.length===0){teamGrid.innerHTML=`\n                <div class="empty-state">\n                    <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ‘¥</div>\n                    <h3>No Team Members</h3>\n                    <p>No team members found.</p>\n                </div>\n            `;return}const membersHTML=this.users.map(user=>this.renderTeamMember(user)).join("");teamGrid.innerHTML=membersHTML}renderTeamMember(user){const initials=this.getUserInitials(user.full_name||user.username);const isCurrentUser=user.id===window.authManager.getCurrentUser()?.id;return`\n            <div class="team-member">\n                <div class="member-avatar">${initials}</div>\n                <div class="member-name">${this.escapeHtml(user.full_name||user.username)}</div>\n                <div class="member-email">${this.escapeHtml(user.email)}</div>\n                <div class="member-role">${this.escapeHtml(user.role||"User")}${isCurrentUser?" (You)":""}</div>\n            </div>\n        `}getUserInitials(name){return name.split(" ").map(n=>n.charAt(0)).join("").toUpperCase().slice(0,2)}handleKeyboardShortcuts(e){if((e.ctrlKey||e.metaKey)&&e.key==="n"){e.preventDefault();openCreateTaskModal()}if(e.key==="Escape"){this.closeAllModals()}if((e.ctrlKey||e.metaKey)&&e.key==="r"){e.preventDefault();this.refreshAll()}}async refreshAll(){const refreshIcon=document.getElementById("refreshIcon");if(refreshIcon){refreshIcon.style.animation="spin 1s linear infinite"}try{await Promise.all([this.loadUsers(),this.loadTasks(),this.loadDashboardStats()]);showNotification("Data refreshed successfully!","success")}catch(error){showNotification("Failed to refresh data.","error")}finally{if(refreshIcon){setTimeout(()=>{refreshIcon.style.animation=""},1e3)}}}closeAllModals(){document.querySelectorAll(".modal.active").forEach(modal=>{modal.classList.remove("active")});this.resetTaskForm()}resetTaskForm(){const form=document.getElementById("taskForm");if(form){form.reset()}this.currentEditingTask=null;const estimatedHours=document.getElementById("taskEstimatedHours");if(estimatedHours){estimatedHours.value="1.0"}const priority=document.getElementById("taskPriority");if(priority){priority.value="medium"}}openTaskModal(title="Create New Task"){const modal=document.getElementById("taskModal");const modalTitle=document.getElementById("modalTitle");const submitBtn=document.getElementById("taskSubmitBtn");if(modalTitle){modalTitle.textContent=title}if(submitBtn){const textSpan=submitBtn.querySelector(".btn-text");if(textSpan){textSpan.textContent=title.includes("Edit")?"Update Task":"Create Task"}}if(modal){modal.classList.add("active")}this.setDefaultDates();setTimeout(()=>{const titleField=document.getElementById("taskTitle");if(titleField){titleField.focus()}},100)}closeTaskModal(){const modal=document.getElementById("taskModal");if(modal){modal.classList.remove("active")}this.resetTaskForm()}setDefaultDates(){if(this.currentEditingTask)return;const now=new Date;now.setMinutes(now.getMinutes()-now.getTimezoneOffset());const startDateInput=document.getElementById("taskStartDate");if(startDateInput&&!startDateInput.value){startDateInput.value=now.toISOString().slice(0,16)}const tomorrow=new Date(now);tomorrow.setDate(tomorrow.getDate()+1);const dueDateInput=document.getElementById("taskDueDate");if(dueDateInput&&!dueDateInput.value){dueDateInput.value=tomorrow.toISOString().slice(0,16)}}escapeHtml(text){const div=document.createElement("div");div.textContent=text;return div.innerHTML}destroy(){if(this.refreshInterval){clearInterval(this.refreshInterval)}this.clearAllNotificationIntervals()}timerIntervals={};async startTimer(taskId){try{await window.api.request(`/tasks/${taskId}/time/start`,{method:"POST"});this.updateTimerDisplay(taskId)}catch(error){showNotification("Failed to start timer","error")}}async pauseTimer(taskId){try{await window.api.request(`/tasks/${taskId}/time/pause`,{method:"POST"});this.updateTimerDisplay(taskId)}catch(error){showNotification("Failed to pause timer","error")}}async stopTimer(taskId){try{await window.api.request(`/tasks/${taskId}/time/pause`,{method:"POST"});this.clearTimerInterval(taskId);this.updateTimerDisplay(taskId,true)}catch(error){showNotification("Failed to stop timer","error")}}clearTimerInterval(taskId){if(this.timerIntervals[taskId]){clearInterval(this.timerIntervals[taskId]);delete this.timerIntervals[taskId]}}async updateTimerDisplay(taskId,reset=false){try{const res=await window.api.request(`/tasks/${taskId}/time/active`);const historyRes=await window.api.request(`/tasks/${taskId}/time/history`);const timerDisplay=document.getElementById(`timer-display-${taskId}`);const timerTotal=document.getElementById(`timer-total-${taskId}`);let totalSeconds=0;if(historyRes.history){for(const entry of historyRes.history){if(entry.duration)totalSeconds+=Math.floor(entry.duration*60)}}if(res.entry&&res.entry.startTime&&!res.entry.endTime){const start=new Date(res.entry.startTime);const now=new Date;const diff=Math.floor((now-start)/1e3);timerDisplay.textContent=this.formatSeconds(diff);this.clearTimerInterval(taskId);this.timerIntervals[taskId]=setInterval(()=>{const now2=new Date;const diff2=Math.floor((now2-start)/1e3);timerDisplay.textContent=this.formatSeconds(diff2)},1e3);timerTotal.textContent=`Total: ${this.formatSeconds(totalSeconds+diff)}`}else{timerDisplay.textContent="--:--:--";timerTotal.textContent=`Total: ${this.formatSeconds(totalSeconds)}`;this.clearTimerInterval(taskId)}}catch(error){}}formatSeconds(seconds){const h=String(Math.floor(seconds/3600)).padStart(2,"0");const m=String(Math.floor(seconds%3600/60)).padStart(2,"0");const s=String(seconds%60).padStart(2,"0");return`${h}:${m}:${s}`}async scheduleDeadlineNotifications(){if(typeof Notification!=="undefined"&&Notification.permission==="default"){try{await Notification.requestPermission()}catch(e){}}this.clearAllNotificationIntervals();if(typeof Notification==="undefined"||Notification.permission!=="granted")return;const now=new Date;const currentUser=window.authManager?.getCurrentUser?.();this.tasks.forEach(task=>{if(!task.due_date||task.status==="completed")return;if(currentUser&&task.assigned_to!==currentUser.id)return;const due=new Date(task.due_date);const msToDue=due-now;if(msToDue>0&&msToDue<=24*60*60*1e3){const notify=()=>{new Notification("Task Deadline Approaching",{body:`Task "${task.title}" is due at ${due.toLocaleString()}. Please complete it soon!`,tag:`task-deadline-${task.id}`})};if(msToDue<=2*60*60*1e3){notify();this.notificationIntervals[task.id]=setInterval(()=>{const t=this.tasks.find(t=>t.id===task.id);if(t&&t.status!=="completed"){notify()}else{this.clearNotificationInterval(task.id)}},2*60*60*1e3)}else{const firstTimeout=msToDue-2*60*60*1e3;this.notificationIntervals[task.id]=setTimeout(()=>{notify();this.notificationIntervals[task.id]=setInterval(()=>{const t=this.tasks.find(t=>t.id===task.id);if(t&&t.status!=="completed"){notify()}else{this.clearNotificationInterval(task.id)}},2*60*60*1e3)},firstTimeout)}}})}clearNotificationInterval(taskId){const interval=this.notificationIntervals[taskId];if(interval){clearInterval(interval);clearTimeout(interval);delete this.notificationIntervals[taskId]}}clearAllNotificationIntervals(){Object.keys(this.notificationIntervals).forEach(taskId=>{this.clearNotificationInterval(taskId)})}async notifyTaskAssignment(taskTitle,assignedUserId,assignedUserName){if(typeof Notification==="undefined")return;const currentUser=window.authManager?.getCurrentUser?.();if(!currentUser||currentUser.id!==assignedUserId)return;if(Notification.permission==="default"){try{await Notification.requestPermission()}catch(e){}}if(Notification.permission==="granted"){new Notification("New Task Assigned",{body:`You have been assigned a new task: "${taskTitle}"`,tag:`task-assigned-${taskTitle}`})}}}window.showTab=function(tabName){document.querySelectorAll(".nav-tab").forEach(tab=>{tab.classList.remove("active")});document.querySelectorAll(".tab-content").forEach(content=>{content.classList.remove("active")});const clickedTab=document.querySelector(`[data-tab="${tabName}"]`);if(clickedTab){clickedTab.classList.add("active")}const content=document.getElementById(tabName);if(content){content.classList.add("active")}if(tabName==="tasks"&&window.taskManager){window.taskManager.loadTasks()}else if(tabName==="team"&&window.taskManager){window.taskManager.loadUsers()}};window.openCreateTaskModal=function(){if(window.taskManager){window.taskManager.openTaskModal()}};window.closeTaskModal=function(){if(window.taskManager){window.taskManager.closeTaskModal()}};window.filterTasks=function(){if(window.taskManager){window.taskManager.filterTasks()}};window.searchTasks=function(){if(window.taskManager){window.taskManager.searchTasks()}};window.refreshDashboard=function(){if(window.taskManager){window.taskManager.refreshAll()}};window.showNotification=function(message,type="info"){const container=document.getElementById("notificationContainer");if(!container)return;const notification=document.createElement("div");notification.className=`notification ${type}`;notification.textContent=message;notification.addEventListener("click",()=>{notification.remove()});container.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove()}},5e3)};window.formatDate=function(dateString){if(!dateString)return"No date";const date=new Date(dateString);const now=new Date;const diffTime=Math.abs(now-date);const diffDays=Math.ceil(diffTime/(1e3*60*60*24));if(diffDays===0){return"Today"}else if(diffDays===1){return date<now?"Yesterday":"Tomorrow"}else if(diffDays<7){return`${diffDays} days ${date<now?"ago":"away"}`}else{return date.toLocaleDateString()}};window.formatDuration=function(minutes){if(!minutes)return"0m";const hours=Math.floor(minutes/60);const mins=minutes%60;if(hours===0){return`${mins}m`}else if(mins===0){return`${hours}h`}else{return`${hours}h ${mins}m`}};let taskStatsChartInstance=null;let userProductivityChartInstance=null;async function fetchAndRenderReports(){const startDate=document.getElementById("reportStartDate").value;const endDate=document.getElementById("reportEndDate").value;const params=[];if(startDate)params.push(`startDate=${encodeURIComponent(startDate)}`);if(endDate)params.push(`endDate=${encodeURIComponent(endDate)}`);const query=params.length?`?${params.join("&")}`:"";const taskStats=await window.api.request(`/reports/task-stats${query}`);renderTaskStatsChart(taskStats);const userProductivity=await window.api.request(`/reports/user-productivity${query}`);renderUserProductivityChart(userProductivity);const timeTracking=await window.api.request(`/reports/time-tracking${query}`);renderTimeTracking(timeTracking)}function renderTaskStatsChart(stats){const container=document.getElementById("taskStatsChart");if(!container)return;container.innerHTML='<canvas id="taskStatsCanvas" height="120"></canvas>';const ctx=document.getElementById("taskStatsCanvas").getContext("2d");if(taskStatsChartInstance)taskStatsChartInstance.destroy();taskStatsChartInstance=new Chart(ctx,{type:"bar",data:{labels:["Completed","Pending","In Progress","Cancelled"],datasets:[{label:"Tasks",data:[stats.completed,stats.pending,stats.in_progress,stats.cancelled],backgroundColor:["#4caf50","#ff9800","#2196f3","#f44336"]}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}})}function renderUserProductivityChart(data){const container=document.getElementById("userProductivityTable");if(!container)return;container.innerHTML='<canvas id="userProductivityCanvas" height="120"></canvas>';const ctx=document.getElementById("userProductivityCanvas").getContext("2d");if(userProductivityChartInstance)userProductivityChartInstance.destroy();userProductivityChartInstance=new Chart(ctx,{type:"bar",data:{labels:data.map(u=>u.full_name||u.username),datasets:[{label:"Completed Tasks",data:data.map(u=>u.completed_tasks),backgroundColor:"#4caf50"},{label:"Total Time (min)",data:data.map(u=>u.total_minutes),backgroundColor:"#2196f3"}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}})}function renderTimeTracking(data){const container=document.getElementById("timeTrackingTable");if(!container)return;let html=`<table class="report-table"><thead><tr><th>User</th><th>Task</th><th>Entries</th><th>Total Time (min)</th><th>Avg Time (min)</th></tr></thead><tbody>`;data.forEach(row=>{html+=`<tr><td>${row.username}</td><td>${row.title||"-"}</td><td>${row.entries}</td><td>${row.total_minutes}</td><td>${row.avg_minutes}</td></tr>`});html+="</tbody></table>";container.innerHTML=html}document.addEventListener("DOMContentLoaded",()=>{console.log("ğŸŒŸ TaskFlow application starting...");window.taskManager=new TaskManager;if(window.authManager&&window.authManager.isAuthenticated()){window.taskManager.init()}window.addEventListener("authTokenChanged",event=>{if(event.detail.token){window.taskManager.init()}else{if(window.taskManager){window.taskManager.destroy()}}});setTimeout(()=>{if(window.authManager){window.authManager.hideLoadingScreen()}},1500)});document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"&&window.taskManager&&window.authManager.isAuthenticated()){window.taskManager.loadDashboardStats()}});window.addEventListener("beforeunload",()=>{if(window.taskManager){window.taskManager.destroy()}});if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(registration=>{console.log("SW registered: ",registration)}).catch(registrationError=>{console.log("SW registration failed: ",registrationError)})})}if(typeof module!=="undefined"&&module.exports){module.exports={TaskManager:TaskManager}}